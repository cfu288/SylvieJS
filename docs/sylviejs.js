var Se=Object.defineProperty;var u=(a,s)=>Se(a,"name",{value:s,configurable:!0});var Ae=(a,s)=>()=>(a&&(s=a(a=0)),s);var Oe=(a,s)=>{for(var e in s)Se(a,e,{get:s[e],enumerable:!0})};var pe=(a,s,e)=>{if(!s.has(a))throw TypeError("Cannot "+e)};var k=(a,s,e)=>(pe(a,s,"read from private field"),e?e.call(a):s.get(a)),q=(a,s,e)=>{if(s.has(a))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(a):s.set(a,e)},ge=(a,s,e,t)=>(pe(a,s,"write to private field"),t?t.call(a,e):s.set(a,e),e);var L=(a,s,e)=>(pe(a,s,"access private method"),e);var D=(a,s,e)=>new Promise((t,i)=>{var r=o=>{try{l(e.next(o))}catch(c){i(c)}},n=o=>{try{l(e.throw(o))}catch(c){i(c)}},l=o=>o.done?t(o.value):Promise.resolve(o.value).then(r,n);l((e=e.apply(a,s)).next())});var ue,$e,de,O,Fe=Ae(()=>{O=class{constructor(){q(this,ue);q(this,de,u(()=>D(this,null,function*(){let s=L(this,ue,$e).call(this);return new Promise((e,t)=>{s.onsuccess=({target:i})=>{this.db=i.result,e(this)},s.onerror=i=>{t(i)}})}),"#initializeCatalog"));this.db=null}initialize(){return new Promise((s,e)=>{k(this,de).call(this).then(t=>{s(t)}).catch(t=>{console.log(t),e(t)})})}getAppKeyAsync(s,e){return D(this,null,function*(){let r=this.db.transaction(["IDBAKV"],"readonly").objectStore("IDBAKV").index("appkey"),n=`${s},${e}`,l=r.get(n);return new Promise((o,c)=>{l.onsuccess=({target:h})=>{let d=h.result;(d===null||typeof d=="undefined")&&(d={id:0,success:!1}),o(d)},l.onerror=h=>{c(h)}})})}setAppKeyAsync(s,e,t){return D(this,null,function*(){let r=this.db.transaction(["IDBAKV"],"readwrite").objectStore("IDBAKV"),n=r.index("appkey"),l=`${s},${e}`,o=n.get(l);return new Promise((c,h)=>{o.onsuccess=({target:d})=>{let p=d.result;p==null?p={app:s,key:e,appkey:`${s},${e}`,val:t}:p.val=t;let f=r.put(p);f.onerror=()=>{h({success:!1,error:f.error}),console.error("IDBCatalog.setAppKey (set) onerror"),console.error(o.error)},f.onsuccess=()=>{c({success:!0})}},o.onerror=()=>{h({success:!1,error:o.error}),console.error("IDBCatalog.setAppKey (get) onerror"),console.error(o.error)}})})}deleteAppKeyAsync(s){let i=this.db.transaction(["IDBAKV"],"readwrite").objectStore("IDBAKV").delete(s);return new Promise((r,n)=>{i.onsuccess=()=>{r({success:!0})},i.onerror=l=>{n({success:!1,error:l}),console.error("IDBCatalog.deleteAppKey raised onerror"),console.error(i.error)}})}getAppKeysAsync(s){return D(this,null,function*(){let i=this.db.transaction(["IDBAKV"],"readonly").objectStore("IDBAKV").index("app"),r=IDBKeyRange.only(s),n=i.openCursor(r),l=[];return new Promise((o,c)=>{n.onsuccess=()=>{let h=n.result;if(h){let d=h.value;l.push(d),h.continue()}else o(l)},n.onerror=h=>{c(h)}})})}getAllKeys(s){let i=this.db.transaction(["IDBAKV"],"readonly").objectStore("IDBAKV").openCursor(),r=[];i.onsuccess=((n,l)=>({target:o})=>{let c=o.result;if(c){let h=c.value;n.push(h),c.continue()}else typeof l=="function"?l(n):console.log(n)})(r,s),i.onerror=(n=>l=>{typeof n=="function"&&n(null)})(s)}};u(O,"IDBCatalog"),ue=new WeakSet,$e=u(function(){let s=indexedDB.open("IDBCatalog",1);return s.onupgradeneeded=({target:e})=>{let t=e.result;if(t.objectStoreNames.contains("IDBAKV")&&t.deleteObjectStore("IDBAKV"),!t.objectStoreNames.contains("IDBAKV")){let i=t.createObjectStore("IDBAKV",{keyPath:"id",autoIncrement:!0});i.createIndex("app","app",{unique:!1}),i.createIndex("key","key",{unique:!1}),i.createIndex("appkey","appkey",{unique:!0})}},s},"#openCatalog"),de=new WeakMap});var qe={};Oe(qe,{IndexedDBAdapter:()=>se});var $,re,fe,Me,se,je=Ae(()=>{Fe();$=typeof window!="undefined"&&!!window.__loki_idb_debug;$&&console.log("DEBUG: Running crypted-indexeddb-adapter in DEBUG mode");if(!window.crypto.subtle)throw alert("Required crypto lib is not available, are you using SSL?"),new Error("Required crypto lib is not available");se=class{constructor(s){q(this,fe);q(this,re,u(()=>{this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},"#closeDatabase"));this.loadDatabase=u((s,e)=>{if($&&console.debug("loading database"),this.catalog===null||this.catalog.db===null){new O().initialize().then(t=>{this.catalog=t,this.loadDatabase(s,e)});return}this.catalog.getAppKeyAsync(this.app,s).then(t=>{let{success:i}=t;if(i===!1)e(null);else{let{val:r}=t;this.options.beforeRead?this.options.beforeRead(r).then(n=>{$&&console.debug(`DESERIALIZED STRING: ${n}`),e(n)}).catch(n=>{console.error(n),e(n)}):e(r)}}).catch(t=>{console.error(t),e(t)})},"loadDatabase");this.loadDatabaseAsync=u(s=>D(this,null,function*(){return $&&console.debug("loading database"),new Promise((e,t)=>{let i=u(()=>this.catalog.getAppKeyAsync(this.app,s).then(r=>{let{success:n}=r;if(n===!1)t(null);else{let{val:l}=r,o=l;this.options.beforeRead?this.options.beforeRead(o).then(c=>{$&&console.debug(`DESERIALIZED STRING: ${c}`),e(c)}).catch(c=>{t(c)}):e(o)}}),"doLoad");this.catalog===null||this.catalog.db===null?new O().initialize().then(r=>{this.catalog=r,i()}).catch(r=>{t(r)}):i()})}),"loadDatabaseAsync");this.saveDatabase=u((s,e,t)=>{$&&console.debug(`in saveDatabase(${s}, ${e}, ${t})`);let i=u(()=>{this.options.beforeWrite?this.options.beforeWrite(e).then(r=>{$&&console.debug(`SERIALIZED STRING: ${r}`),this.catalog.setAppKeyAsync(this.app,s,r).then(n=>{t(n)}).catch(n=>{t(n)})}).catch(r=>{t(r)}):($&&console.debug(`SERIALIZED STRING: ${e}`),this.catalog.setAppKeyAsync(this.app,s,e).then(r=>{t(r)}).catch(r=>{t(r)}))},"doSave");this.catalog===null||this.catalog.db===null?new O().initialize().then(r=>{this.catalog=r,this.saveDatabaseAsync(s,e).then(()=>{t(void 0)}).catch(n=>{t(new Error("Error saving database: "+n))}).finally(()=>{this.options.closeAfterSave===!0&&k(this,re).call(this)})}).catch(r=>{t(new Error("Error saving database: "+r))}):i()},"saveDatabase");this.deleteDatabase=u((s,e)=>{if(this.catalog===null||this.catalog.db===null){new O().initialize().then(t=>{this.catalog=t,this.deleteDatabase(s,e)}).catch(t=>{e(new Error("Error deleting database: "+t))});return}this.catalog.getAppKeyAsync(this.app,s).then(t=>{let i=t.id;i!==0&&this.catalog.deleteAppKeyAsync(i).then(r=>{typeof e=="function"&&e(r)}).catch(r=>{typeof e=="function"&&e({success:!1,error:r})})}).catch(t=>{typeof e=="function"&&e({success:!1,error:t})})},"deleteDatabase");this.deleteDatabasePartitions=u(s=>{this.getDatabaseList(e=>{if(e instanceof Error)throw e;e.forEach(t=>{t.startsWith(s)&&this.deleteDatabase(t)})})},"deleteDatabasePartitions");this.getDatabaseList=u(s=>{if(this.catalog===null||this.catalog.db===null){new O().initialize().then(e=>{this.catalog=e,this.getDatabaseList(s)}).catch(e=>{s(new Error("Error getting database list: "+e))});return}this.catalog.getAppKeysAsync(this.app).then(e=>{let t=[];for(let i=0;i<e.length;i++)t.push(e[i].key);typeof s=="function"&&s(t)}).catch(e=>{s(e)})},"getDatabaseList");this.getDatabaseListAsync=u(()=>new Promise((s,e)=>{this.catalog===null||this.catalog.db===null?new O().initialize().then(t=>{this.catalog=t,this.catalog.getAppKeysAsync(this.app).then(i=>{let r=i.map(n=>n.key);s(r)}).catch(i=>{e(i)})}).catch(t=>{e(t)}):this.catalog.getAppKeysAsync(this.app).then(t=>{let i=t.map(r=>r.key);s(i)}).catch(t=>{e(t)})}),"getDatabaseListAsync");this.getCatalogSummary=u(s=>{if(this.catalog===null||this.catalog.db===null){new O().initialize().then(e=>{this.catalog=e,this.getCatalogSummary(s)}).catch(e=>{s(new Error("Error getting database list: "+e))});return}this.catalog.getAllKeys(e=>{let t=[],i,r,n,l,o;for(let c=0;c<e.length;c++)i=e[c],n=i.app||"",l=i.key||"",o=i.val||"",r=n.length*2+l.length*2+o.length+1,t.push({app:i.app,key:i.key,size:r});typeof s=="function"&&s(t)})},"getCatalogSummary");if($&&console.log("Initialized crypted-indexeddb-adapter"),this.app="sylvie",this.options=s||{},typeof(s==null?void 0:s.appname)!="undefined"&&(this.app=s==null?void 0:s.appname),this.catalog=null,!L(this,fe,Me).call(this))throw new Error("IndexedDB does not seem to be supported for your environment")}saveDatabaseAsync(s,e){return D(this,null,function*(){return new Promise((t,i)=>{let r=u(()=>{this.options.beforeWrite?this.options.beforeWrite(e).then(n=>{$&&console.debug(`ENCRYPTED STRING: ${n}`),this.catalog.setAppKeyAsync(this.app,s,n).then(l=>{l.success===!0?t():i(l)}).catch(l=>{i(l)})}).catch(n=>{i(n)}):($&&console.debug(`SERIALIZED STRING: ${e}`),this.catalog.setAppKeyAsync(this.app,s,e).then(n=>{n.success===!0?t():i(n)}).catch(n=>{i(n)}))},"doSave");this.catalog===null||this.catalog.db===null?new O().initialize().then(n=>{this.catalog=n,this.saveDatabaseAsync(s,e).then(t).catch(l=>{i(new Error("Error saving database: "+l))}).finally(()=>{this.options.closeAfterSave===!0&&k(this,re).call(this)})}).catch(n=>{i(n)}):r()})})}deleteDatabaseAsync(s){return D(this,null,function*(){return new Promise((e,t)=>{let i=u(()=>this.catalog.getAppKeyAsync(this.app,s).then(r=>{let n=r.id;n!==0&&this.catalog.deleteAppKeyAsync(n).then(l=>{l.success===!0?e():t(l)}).catch(l=>{t(l)})}).catch(r=>{t(r)}),"doDelete");this.catalog===null||this.catalog.db===null?new O().initialize().then(r=>{this.catalog=r,i()}).catch(r=>{t(r)}):i()})})}};u(se,"IndexedDBAdapter"),re=new WeakMap,fe=new WeakSet,Me=u(function(){return!!(typeof indexedDB!="undefined"&&indexedDB)},"#checkIDBAvailability");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:se})});var X,ne,H=class{constructor(){q(this,X);this.loadDatabase=u((s,e)=>{L(this,X,ne).call(this).then(()=>{this.fs.stat(s).then(t=>{t.isFile()&&this.fs.readFile(s,{encoding:"utf8"}).then(i=>{e(i)}).catch(i=>{e(i)})}).catch(t=>{e(t)}).catch(e)})},"loadDatabase");this.saveDatabase=u((s,e,t)=>{L(this,X,ne).call(this).then(()=>{let i=`${s}~`;this.fs.writeFile(i,e).then(()=>{this.fs.rename(i,s).then(()=>t()).catch(t)}).catch(t)}).catch(t)},"saveDatabase");this.deleteDatabase=u((s,e)=>{L(this,X,ne).call(this).then(()=>{this.fs.unlink(s).then(()=>e()).catch(t=>{e(t)})}).catch(e)},"deleteDatabase")}};u(H,"FsAdapter"),X=new WeakSet,ne=u(function(){return D(this,null,function*(){if(this.fs===null||this.fs===void 0)try{this.fs=yield import("node:fs/promises")}catch(s){console.error(`FsAdapter - ${s}`)}})},"#initializeFS");var j=Object.prototype.hasOwnProperty;function V(a,s,e){if(e===!1)return a[s];let t=s.split("."),i=a;for(;t.length>0;)i=i[t.shift()];return i}u(V,"deepProperty");function Pe(a,s){if(s=="parse-stringify")return I(a,s);for(var e=[],t=0,i=a.length;t<i;t++)e[t]=I(a[t],s);return e}u(Pe,"cloneObjectArray");function I(a,s){if(a==null)return null;var e=s||"parse-stringify",t;switch(e){case"parse-stringify":t=JSON.parse(JSON.stringify(a));break;case"shallow":t=Object.create(a.constructor.prototype),Object.keys(a).map(function(r){t[r]=a[r]});break;case"shallow-assign":t=Object.create(a.constructor.prototype),Object.assign(t,a);break;case"shallow-recurse-objects":t=I(a,"shallow");var i=Object.keys(a);i.forEach(function(r){typeof a[r]=="object"&&a[r].constructor.name==="Object"?t[r]=I(a[r],"shallow-recurse-objects"):Array.isArray(a[r])&&(t[r]=Pe(a[r],"shallow-recurse-objects"))});break;default:break}return t}u(I,"clone");function J(a){Object.isFrozen(a)||Object.freeze(a)}u(J,"freeze");function C(a){var s,e;if(Array.isArray(a)){for(e=0;e<a.length;e++)C(a[e]);J(a)}else if(a!==null&&typeof a=="object"){for(s in a)Object.hasOwn(a,s)&&C(a[s]);J(a)}}u(C,"deepFreeze");function W(a){return Object.isFrozen(a)?I(a,"shallow"):a}u(W,"unFreeze");var y={};Oe(y,{copyProperties:()=>Be,getIn:()=>Le,resolveTransformObject:()=>ke,resolveTransformParams:()=>Ne});var Be=u(function(a,s){var e;for(e in a)s[e]=a[e]},"copyProperties"),ke=u(function(a,s,e){var t,i;if(typeof e!="number"&&(e=0),++e>=10)return a;for(t in a)typeof a[t]=="string"&&a[t].indexOf("[%lktxp]")===0?(i=a[t].substring(8),Object.hasOwn(s,i)&&(a[t]=s[i])):typeof a[t]=="object"&&(a[t]=y.resolveTransformObject(a[t],s,e));return a},"resolveTransformObject"),Ne=u(function(a,s){var e,t,i=[];if(typeof s=="undefined")return a;for(e=0;e<a.length;e++)t=I(a[e],"shallow-recurse-objects"),i.push(ke(t,s));return i},"resolveTransformParams"),Le=u(function(a,s,e){if(a!=null){if(!e)return a[s];if(typeof s=="string"&&(s=s.split(".")),!Array.isArray(s))throw new Error("path must be a string or array. Found "+typeof s);for(var t=0,i=s.length;a!=null&&t<i;)a=a[s[t++]];return t&&t==i?a:void 0}},"getIn");function le(a){return a.indexOf(".")!==-1}u(le,"isDeepProperty");function Ve(a,s){return a+s}u(Ve,"add");function Te(a,s){return a-s}u(Te,"sub");function ae(a){return a.reduce(Ve,0)/a.length}u(ae,"average");function Re(a){let s=ae(a),e=a.map(function(r){let n=r-s;return n*n}),t=ae(e);return Math.sqrt(t)}u(Re,"standardDeviation");function me(a){return typeof a=="string"||Array.isArray(a)?function(s){return a.indexOf(s)!==-1}:typeof a=="object"&&a!==null?function(s){return Object.hasOwn(a,s)}:null}u(me,"containsCheckFn");function _(a,s,e,t,i,r){let n=r||0,l=s[n],o=!1,c;if(a!==null&&typeof a=="object"&&l in a&&(c=a[l]),n+1>=s.length)o=e(c,t,i);else if(Array.isArray(c))for(let h=0,d=c.length;h<d&&(o=_(c[h],s,e,t,i,n+1),o!==!0);h+=1);else o=_(c,s,e,t,i,n+1);return o}u(_,"dotSubScan");var b={aeq:ye,lt:be,gt:ve};function ye(a,s){var e,t,i,r;if(a===s)return!0;if(!a||!s||a===!0||s===!0||a!==a||s!==s){switch(a){case void 0:i=1;break;case null:i=1;break;case!1:i=3;break;case!0:i=4;break;case"":i=5;break;default:i=a===a?9:0;break}switch(s){case void 0:r=1;break;case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=s===s?9:0;break}if(i!==9||r!==9)return i===r}return e=Number(a),t=Number(s),e===e||t===t?e===t:(e=a.toString(),t=s.toString(),e==t)}u(ye,"aeqHelper");function be(a,s,e){var t,i,r,n;if(!a||!s||a===!0||s===!0||a!==a||s!==s){switch(a){case void 0:r=1;break;case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=a===a?9:0;break}switch(s){case void 0:n=1;break;case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=s===s?9:0;break}if(r!==9||n!==9)return r===n?e:r<n}return t=Number(a),i=Number(s),t===t&&i===i?t<i?!0:t>i?!1:e:t===t&&i!==i?!0:i===i&&t!==t?!1:a<s?!0:a>s?!1:a==s?e:(t=a.toString(),i=s.toString(),t<i?!0:t==i?e:!1)}u(be,"ltHelper");function ve(a,s,e){var t,i,r,n;if(!a||!s||a===!0||s===!0||a!==a||s!==s){switch(a){case void 0:r=1;break;case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=a===a?9:0;break}switch(s){case void 0:n=1;break;case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=s===s?9:0;break}if(r!==9||n!==9)return r===n?e:r>n}return t=Number(a),i=Number(s),t===t&&i===i?t>i?!0:t<i?!1:e:t===t&&i!==i?!1:i===i&&t!==t||a>s?!0:a<s?!1:a==s?e:(t=a.toString(),i=s.toString(),t>i?!0:t==i?e:!1)}u(ve,"gtHelper");function we(a,s,e){return b.aeq(a,s)?0:b.lt(a,s,!1)?e?1:-1:b.gt(a,s,!1)?e?-1:1:0}u(we,"sortHelper");function ze(a,s,e){for(var t=0,i,r,n,l,o,c=0,h=a.length;c<h;c++)if(i=a[c],r=i[0],~r.indexOf(".")?(o=r.split("."),n=y.getIn(s,o,!0),l=y.getIn(e,o,!0)):(n=s[r],l=e[r]),t=we(n,l,i[1]),t!==0)return t;return 0}u(ze,"compoundeval");function U(a,s,e){for(var t in s)if(Object.hasOwn(s,t))return A[t](a,s[t],e);return!1}u(U,"doQueryOp");var A={$eq:function(a,s){return a===s},$aeq:function(a,s){return a==s},$ne:function(a,s){return s!==s?a===a:a!==s},$dteq:function(a,s){return b.aeq(a,s)},$gt:function(a,s){return b.gt(a,s,!1)},$gte:function(a,s){return b.gt(a,s,!0)},$lt:function(a,s){return b.lt(a,s,!1)},$lte:function(a,s){return b.lt(a,s,!0)},$jgt:function(a,s){return a>s},$jgte:function(a,s){return a>=s},$jlt:function(a,s){return a<s},$jlte:function(a,s){return a<=s},$between:function(a,s){return a==null?!1:b.gt(a,s[0],!0)&&b.lt(a,s[1],!0)},$jbetween:function(a,s){return a==null?!1:a>=s[0]&&a<=s[1]},$in:function(a,s){return s.indexOf(a)!==-1},$inSet:function(a,s){return s.has(a)},$nin:function(a,s){return s.indexOf(a)===-1},$keyin:function(a,s){return a in s},$nkeyin:function(a,s){return!(a in s)},$definedin:function(a,s){return s[a]!==void 0},$undefinedin:function(a,s){return s[a]===void 0},$regex:function(a,s){return s.test(a)},$containsString:function(a,s){return typeof a=="string"&&a.indexOf(s)!==-1},$containsNone:function(a,s){return!A.$containsAny(a,s)},$containsAny:function(a,s){var e=me(a);return e!==null?Array.isArray(s)?s.some(e):e(s):!1},$contains:function(a,s){var e=me(a);return e!==null?Array.isArray(s)?s.every(e):e(s):!1},$elemMatch:function(a,s){return Array.isArray(a)?a.some(function(e){return Object.keys(s).every(function(t){var i=s[t];return typeof i=="object"&&i||(i={$eq:i}),t.indexOf(".")!==-1?_(e,t.split("."),U,s[t],e):U(e[t],i,e)})}):!1},$type:function(a,s,e){var t=typeof a;return t==="object"&&(Array.isArray(a)?t="array":a instanceof Date&&(t="date")),typeof s!="object"?t===s:U(t,s,e)},$finite:function(a,s){return s===isFinite(a)},$size:function(a,s,e){return Array.isArray(a)?typeof s!="object"?a.length===s:U(a.length,s,e):!1},$len:function(a,s,e){return typeof a=="string"?typeof s!="object"?a.length===s:U(a.length,s,e):!1},$where:function(a,s){return s(a)===!0},$not:function(a,s,e){return!U(a,s,e)},$and:function(a,s,e){for(var t=0,i=s.length;t<i;t+=1)if(!U(a,s[t],e))return!1;return!0},$or:function(a,s,e){for(var t=0,i=s.length;t<i;t+=1)if(U(a,s[t],e))return!0;return!1},$exists:function(a,s){return s?a!==void 0:a===void 0}},Je=["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"];Je.forEach(function(a){var s=A[a];A["$"+a]=function(e,t,i){if(typeof t=="string")return s(e,i[t]);if(typeof t=="function")return s(e,t(i));throw new Error("Invalid argument to $$ matcher")}});var oe={$eq:A.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function Ie(a,s){if(a==="$regex")Array.isArray(s)?s=new RegExp(s[0],s[1]):s instanceof RegExp||(s=new RegExp(s));else if(typeof s=="object")for(let e in s)(e==="$regex"||typeof s[e]=="object")&&(s[e]=Ie(e,s[e]));return s}u(Ie,"precompileQuery");var x=class{constructor(s,e){this.branch=x.prototype.copy;this.$or=x.prototype.findOr;this.$and=x.prototype.findAnd;return this.options=e||{},this.collection=s,this.filteredrows=[],this.filterInitialized=!1,this}reset(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this}toJSON(){let s=this.copy();return s.collection=null,s}limit(s){!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e=new x(this.collection);return e.filteredrows=this.filteredrows.slice(0,s),e.filterInitialized=!0,e}offset(s){!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e=new x(this.collection);return e.filteredrows=this.filteredrows.slice(s),e.filterInitialized=!0,e}copy(){let s=new x(this.collection);return this.filteredrows.length>0&&(s.filteredrows=this.filteredrows.slice()),s.filterInitialized=this.filterInitialized,s}transform(s,e){let t,i,r=this;if(typeof s=="string"&&Object.hasOwn(this.collection.transforms,s)&&(s=this.collection.transforms[s]),typeof s!="object"||!Array.isArray(s))throw new Error("Invalid transform");for(typeof e!="undefined"&&(s=y.resolveTransformParams(s,e)),t=0;t<s.length;t++)switch(i=s[t],i.type){case"find":r.find(i.value);break;case"where":r.where(i.value);break;case"simplesort":r.simplesort(i.property,i.desc||i.options);break;case"compoundsort":r.compoundsort(i.value);break;case"sort":r.sort(i.value);break;case"limit":r=r.limit(i.value);break;case"offset":r=r.offset(i.value);break;case"map":r=r.map(i.value,i.dataOptions);break;case"eqJoin":r=r.eqJoin(i.joinData,i.leftJoinKey,i.rightJoinKey,i.mapFun,i.dataOptions);break;case"mapReduce":r=r.mapReduce(i.mapFunction,i.reduceFunction);break;case"update":r.update(i.value);break;case"remove":r.remove();break;default:break}return r}sort(s){!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e=((t,i)=>(r,n)=>t(i[r],i[n]))(s,this.collection.data);return this.filteredrows.sort(e),this}simplesort(s,e){let t,i=10,r=this.collection.data.length,n=this.filteredrows.length,l=Object.hasOwn(this.collection.binaryIndices,s);if((typeof e=="undefined"||e===!1)&&(e={desc:!1}),e===!0&&(e={desc:!0}),n===0){if(this.filterInitialized)return this;if(Object.hasOwn(this.collection.binaryIndices,s))return this.collection.ensureIndex(s),this.filteredrows=this.collection.binaryIndices[s].values.slice(0),e.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!e.disableIndexIntersect&&l&&(t=r/n,e.useJavascriptSorting&&(i=6),t<=i||e.forceIndexIntersect)){let c,h=this.filteredrows,d={};for(c=0;c<n;c++)d[h[c]]=!0;let p=this.collection.binaryIndices[s].values;return this.filteredrows=p.filter(f=>d[f]),e.desc&&this.filteredrows.reverse(),this}if(e.useJavascriptSorting)return this.sort((c,h)=>{if(c[s]===h[s])return 0;if(c[s]>h[s])return 1;if(c[s]<h[s])return-1});let o=((c,h,d)=>{let p,f,m;return(g,S)=>(~c.indexOf(".")?(m=c.split("."),p=y.getIn(d[g],m,!0),f=y.getIn(d[S],m,!0)):(p=d[g][c],f=d[S][c]),we(p,f,h))})(s,e.desc,this.collection.data);return this.filteredrows.sort(o),this}compoundsort(s){if(s.length===0)throw new Error("Invalid call to compoundsort, need at least one property");let e;if(s.length===1)return e=s[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(let i=0,r=s.length;i<r;i+=1)e=s[i],Array.isArray(e)||(s[i]=[e,!1]);!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let t=((i,r)=>(n,l)=>ze(i,r[n],r[l]))(s,this.collection.data);return this.filteredrows.sort(t),this}findOr(s){let e=null,t=0,i=0,r=[],n=[],l=0;for(let o=0,c=s.length;o<c;o++)for(e=this.branch().find(s[o]).filteredrows,i=e.length,t=0;t<i;t++)l=e[t],n[l]===void 0&&(n[l]=!0,r.push(l));return this.filteredrows=r,this.filterInitialized=!0,this}findAnd(s){for(let e=0,t=s.length;e<t;e++){if(this.count()===0)return this;this.find(s[e])}return this}find(s,e){if(this.collection.data.length===0)return this.filteredrows=[],this.filterInitialized=!0,this;let t=s||"getAll",i,r,n,l,o,c,h,d=!1,p=[],f=[],m=null;if(e=e||!1,typeof t=="object"){for(i in t)l={},l[i]=t[i],f.push(l),j.call(t,i)&&(r=i,n=t[i]);if(f.length>1)return this.find({$and:f},e)}if(!r||t==="getAll")return e&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=this.collection.data.length>0?[0]:[],this.filterInitialized=!0)),this;if(r==="$and"||r==="$or")return this[r](n),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(n===null||typeof n!="object"||n instanceof Date)o="$eq",c=n;else if(typeof n=="object"){for(h in n)if(h in n){o=h,c=n[h];break}}else throw new Error("Do not know what you want to do.");(o==="$regex"||typeof c=="object")&&(c=Ie(o,c));let g=r.includes(".");!this.filterInitialized&&this.collection.binaryIndices[r]&&oe[o]&&(this.collection.adaptiveBinaryIndices!==!0&&this.collection.ensureIndex(r),d=!0,m=this.collection.binaryIndices[r]),!d&&o==="$in"&&Array.isArray(c)&&typeof Set!="undefined"&&(c=new Set(c),o="$inSet");let R=A[o];if(typeof R!="function")throw new TypeError('"'+o+'" is not a valid operator');let F=this.collection.data,v=0,z=0,M,Y=0,P;if(this.filterInitialized){if(M=this.filteredrows,z=M.length,g){let N=r.split(".");for(v=0;v<z;v++)if(Y=M[v],P=F[Y],_(P,N,R,c,P)&&(p.push(Y),e))return this.filteredrows=p,this}else for(v=0;v<z;v++)if(Y=M[v],P=F[Y],R(P[r],c,P)&&(p.push(Y),e))return this.filteredrows=p,this}else if(d){let N=this.collection.calculateRange(o,r,c);if(o!=="$in"){for(v=N[0];v<=N[1];v++)if(oe[o]!==!0){if(oe[o](y.getIn(F[m.values[v]],r,g),c)&&(p.push(m.values[v]),e))return this.filteredrows=p,this.filterInitialized=!0,this}else if(p.push(m.values[v]),e)return this.filteredrows=p,this.filterInitialized=!0,this}else for(v=0,z=N.length;v<z;v++)if(p.push(m.values[N[v]]),e)return this.filteredrows=p,this.filterInitialized=!0,this}else if(z=F.length,g){let N=r.split(".");for(v=0;v<z;v++)if(P=F[v],_(P,N,R,c,P)&&(p.push(v),e))return this.filteredrows=p,this.filterInitialized=!0,this}else for(v=0;v<z;v++)if(P=F[v],R(P[r],c,P)&&(p.push(v),e))return this.filteredrows=p,this.filterInitialized=!0,this;return this.filteredrows=p,this.filterInitialized=!0,this}where(s){let e,t=[];if(typeof s=="function")e=s;else throw new TypeError("Argument is not a stored view or a function");if(this.filterInitialized){let i=this.filteredrows.length;for(;i--;)e(this.collection.data[this.filteredrows[i]])===!0&&t.push(this.filteredrows[i]);return this.filteredrows=t,this}else{let i=this.collection.data.length;for(;i--;)e(this.collection.data[i])===!0&&t.push(i);return this.filteredrows=t,this.filterInitialized=!0,this}}count(){return this.filterInitialized?this.filteredrows.length:this.collection.count()}update(s){if(typeof s!="function")throw new TypeError("Argument is not a function");!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e,t=this.filteredrows.length,i=this.collection.data;for(let r=0;r<t;r++)!this.collection.disableFreeze||this.collection.cloneObjects||!this.collection.disableDeltaChangesApi?(e=I(i[this.filteredrows[r]],this.collection.cloneMethod),s(e),this.collection.update(e)):(s(i[this.filteredrows[r]]),this.collection.update(i[this.filteredrows[r]]));return this}remove(){return!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this}mapReduce(s,e){return e(this.data().map(s))}eqJoin(s,e,t,i,r){let n=[],l=[],o,c=[],h=typeof e=="function",d=typeof t=="function",p={};n=this.data(r);let f=n.length;if(s instanceof T)l=s.chain().data(r);else if(s instanceof x){let g=new x(new T(""));g.rightData=s.data(r)}else if(Array.isArray(s))l=s;else throw new TypeError("joinData needs to be an array or result set");let m=l.length;for(let g=0;g<m;g++)o=d?t(l[g]):l[g][t],p[o]=l[g];i||(i=u((g,S)=>({left:g,right:S}),"mapFun"));for(let g=0;g<f;g++)o=h?e(n[g]):n[g][e],c.push(i(n[g],p[o]||{}));return this.collection=new T("joinData"),this.collection.insert(c),this.filteredrows=[],this.filterInitialized=!1,this}data(s){let e=[],t=this.collection.data,i,r,n,l;if(s=s||{},s.removeMeta&&!s.forceClones&&(s.forceClones=!0,s.forceCloneMethod=s.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(s.forceClones=!0,s.forceCloneMethod="parse-stringify"),!this.filterInitialized)if(this.filteredrows.length===0)if(this.collection.cloneObjects||s.forceClones){for(r=t.length,l=s.forceCloneMethod||this.collection.cloneMethod,n=0;n<r;n++)i=I(t[n],l),s.removeMeta&&(delete i.$loki,delete i.meta),e.push(i);return e}else return t.slice();else this.filterInitialized=!0;let o=this.filteredrows;if(r=o.length,this.collection.cloneObjects||s.forceClones)for(l=s.forceCloneMethod||this.collection.cloneMethod,n=0;n<r;n++)i=I(t[o[n]],l),s.removeMeta&&(delete i.$loki,delete i.meta),e.push(i);else for(n=0;n<r;n++)e.push(t[o[n]]);return e}map(s,e){let t=this.data(e).map(s);return this.collection=new T("mappedData"),this.collection.insert(t),this.filteredrows=[],this.filterInitialized=!1,this}};u(x,"ResultSet");var B=class{constructor(){this.addListener=this.on;this.events={};this.asyncListeners=!1}on(s,e){let t;return Array.isArray(s)?(s.forEach(i=>{this.on(i,e)}),e):(t=this.events[s],t||(t=this.events[s]=[]),t.push(e),e)}emit(s,e,t){let i;if(s&&this.events[s])this.events[s].length&&(i=Array.prototype.slice.call(arguments,1),this.events[s].forEach(r=>{this.asyncListeners?setTimeout(()=>{r.apply(this,i)},1):r.apply(this,i)}));else throw new Error(`No event ${s} defined`)}removeListener(s,e){if(Array.isArray(s)){s.forEach(t=>{this.removeListener(t,e)});return}if(this.events[s]){let t=this.events[s];t.splice(t.indexOf(e),1)}}};u(B,"SylvieEventEmitter");var G=class extends B{constructor(e,t,i){super();this.collection=e,this.name=t,this.rebuildPending=!1,this.options=i||{},Object.hasOwn(this.options,"persistent")||(this.options.persistent=!1),Object.hasOwn(this.options,"sortPriority")||(this.options.sortPriority="passive"),Object.hasOwn(this.options,"minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new x(e),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}getSort(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple}rematerialize(e){let t,i,r;e=e||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new x(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);let n=Object.isFrozen(this.filterPipeline);if(Object.hasOwn(e,"removeWhereFilters"))for(n&&(this.filterPipeline=this.filterPipeline.slice()),t=this.filterPipeline.length,i=t;i--;)this.filterPipeline[i].type==="where"&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);let l=this.filterPipeline;for(this.filterPipeline=[],t=l.length,r=0;r<t;r++)this.applyFind(l[r].val,l[r].uid);return n&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this}branchResultset(e,t){let i=this.resultset.branch();return typeof e=="undefined"?i:i.transform(e,t)}toJSON(){let e=new G(this.collection,this.name,this.options);return e.resultset=this.resultset,e.resultdata=[],e.resultsdirty=!0,e.filterPipeline=this.filterPipeline,e.sortFunction=this.sortFunction,e.sortCriteria=this.sortCriteria,e.sortCriteriaSimple=this.sortCriteriaSimple||null,e.sortDirty=this.sortDirty,e.collection=null,e}removeFilters(e={}){this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;let t=Object.isFrozen(this.filterPipeline),i=this.filterPipeline.length>0;this.filterPipeline=[],t&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,e.queueSortPhase===!0&&this.queueSortPhase(),i&&this.emit("filter")}applySort(e){return this.sortFunction=e,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this}applySimpleSort(e,t){return this.sortCriteriaSimple={propname:e,options:t||!1},this.collection.disableFreeze||C(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this}applySortCriteria(e){return this.sortCriteria=e,this.collection.disableFreeze||C(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this}startTransaction(){return this.cachedresultset=this.resultset.copy(),this}commit(){return this.cachedresultset=null,this}rollback(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this}_indexOfFilterWithId(e){if(typeof e=="string"||typeof e=="number"){for(let t=0,i=this.filterPipeline.length;t<i;t+=1)if(e===this.filterPipeline[t].uid)return t}return-1}_addFilter(e){let t=Object.isFrozen(this.filterPipeline);t&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||C(e),this.filterPipeline.push(e),t&&Object.freeze(this.filterPipeline),this.resultset[e.type](e.val)}reapplyFilters(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);let e=this.filterPipeline,t=Object.isFrozen(e);this.filterPipeline=[];for(let i=0,r=e.length;i<r;i+=1)this._addFilter(e[i]);return t&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this}applyFilter(e){let t=this._indexOfFilterWithId(e.uid);if(t>=0){let i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[t]=e,i&&(J(e),Object.freeze(this.filterPipeline)),this.reapplyFilters()}return this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(e),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this}applyFind(e,t){return this.applyFilter({type:"find",val:e,uid:t}),this}applyWhere(e,t){return this.applyFilter({type:"where",val:e,uid:t}),this}removeFilter(e){let t=this._indexOfFilterWithId(e);if(t<0)throw new Error(`Dynamic view does not contain a filter with ID: ${e}`);let i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(t,1),i&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this}count(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()}data(e){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(e)}queueRebuildEvent(){if(this.rebuildPending)return;this.rebuildPending=!0;let e=this;setTimeout(()=>{e.rebuildPending&&(e.rebuildPending=!1,e.emit("rebuild",e))},this.options.minRebuildInterval)}queueSortPhase(){if(this.sortDirty)return;this.sortDirty=!0;let e=this;this.options.sortPriority==="active"?setTimeout(()=>{e.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}performSortPhase(e){!this.sortDirty&&!this.resultsdirty||(e=e||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),e.suppressRebuildEvent||this.emit("rebuild",this))}evaluateDocument(e,t){if(!this.resultset.filterInitialized){this.options.persistent&&(this.resultdata=this.resultset.data()),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}let i=this.resultset.filteredrows,r=t?-1:i.indexOf(+e),n=i.length,l=new x(this.collection);l.filteredrows=[e],l.filterInitialized=!0;let o;for(let h=0,d=this.filterPipeline.length;h<d;h++)o=this.filterPipeline[h],l[o.type](o.val);let c=l.filteredrows.length===0?-1:0;if(!(r===-1&&c===-1)){if(r===-1&&c!==-1){i.push(e),this.options.persistent&&this.resultdata.push(this.collection.data[e]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}if(r!==-1&&c===-1){r<n-1?(i.splice(r,1),this.options.persistent&&this.resultdata.splice(r,1)):(i.length=n-1,this.options.persistent&&(this.resultdata.length=n-1)),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}if(r!==-1&&c!==-1){this.options.persistent&&(this.resultdata[r]=this.collection.data[e]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}}}removeDocument(e){let t,i,r={},n={},l=[],o=this.resultset,c=this.resultset.filteredrows,h=c.length;if(!this.resultset.filterInitialized){this.options.persistent&&(this.resultdata=this.resultset.data()),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}Array.isArray(e)||(e=[e]);let d=e.length;for(i=0;i<d;i++)r[e[i]]=!0;for(t=0;t<h;t++)r[c[t]]&&(n[t]=!0);Object.keys(n).length>0&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((f,m)=>!n[m]),this.options.persistent&&(this.resultdata=this.resultdata.filter((f,m)=>!n[m])),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());let p=u(f=>m=>m<o.filteredrows[f],"filt");for(h=o.filteredrows.length,t=0;t<h;t++)l=e.filter(p(t)),o.filteredrows[t]-=l.length}mapReduce(e,t){return t(this.data().map(e))}};u(G,"DynamicView");var ce=G;var E,ie=class{constructor(s){q(this,E,void 0);ge(this,E,Object.create(null)),this.field=s}set(s,e){k(this,E)[s]?k(this,E)[s].push(e):k(this,E)[s]=[e]}remove(s,e){let t=k(this,E)[s];for(let i in t)t[i]===e&&t.splice(parseInt(i),1);t.length<1&&(k(this,E)[s]=void 0)}get(s){return k(this,E)[s]}clear(){ge(this,E,{})}};u(ie,"ExactIndex"),E=new WeakMap;var Z=class{constructor(s){this.field=s,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}set(s){let e=s[this.field];if(e!==null&&typeof e!="undefined"){if(this.keyMap[e])throw new Error(`Duplicate key for property ${this.field}: ${e}`);this.keyMap[e]=s,this.lokiMap[s.$loki]=e}}get(s){return this.keyMap[s]}byId(s){return this.keyMap[this.lokiMap[s]]}update(s,e){if(this.lokiMap[s.$loki]!==e[this.field]){let t=this.lokiMap[s.$loki];this.set(e),this.keyMap[t]=void 0}else this.keyMap[s[this.field]]=e}remove(s){let e=this.keyMap[s];if(e!==null&&typeof e!="undefined")this.keyMap[s]=void 0,this.lokiMap[e.$loki]=void 0;else throw new Error(`Key is not in unique index: ${this.field}`)}clear(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}};u(Z,"UniqueIndex");Z.prototype.keyMap={};Z.prototype.lokiMap={};function Ee(a){return parseInt(a,10)}u(Ee,"parseBase10");var T=class extends B{constructor(e,t){super();this.stages={};this.commitLog=[];this.configureOptions=u((e={})=>{"adaptiveBinaryIndices"in e&&(this.adaptiveBinaryIndices=e.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},"configureOptions");this.count=u(e=>e?this.chain().find(e).filteredrows.length:this.data.length,"count");this.startTransaction=u(()=>{if(this.transactional){this.cachedData=I(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(let e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].startTransaction()}},"startTransaction");this.commit=u(()=>{if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(let e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].commit()}},"commit");this.rollback=u(()=>{if(this.transactional){this.cachedData!==null&&this.cachedIndex!==null&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(let e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].rollback()}},"rollback");this.mapReduce=u((e,t)=>t(this.data.map(e)),"mapReduce");this.lokiConsoleWrapper={log(e){},warn(e){},error(e){}};this.name=e,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=e,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;let i=this;t=t||{},t.unique&&(Array.isArray(t.unique)||(t.unique=[t.unique]),t.unique.forEach(h=>{i.uniqueNames.push(h)})),t.exact&&t.exact.forEach(h=>{i.constraints.exact[h]=new ie(h)}),this.adaptiveBinaryIndices=Object.hasOwn(t,"adaptiveBinaryIndices")?t.adaptiveBinaryIndices:!0,this.transactional=Object.hasOwn(t,"transactional")?t.transactional:!1,this.cloneObjects=Object.hasOwn(t,"clone")?t.clone:!1,this.cloneMethod=Object.hasOwn(t,"cloneMethod")?t.cloneMethod:"parse-stringify",this.asyncListeners=Object.hasOwn(t,"asyncListeners")?t.asyncListeners:!1,this.disableMeta=Object.hasOwn(t,"disableMeta")?t.disableMeta:!1,this.disableChangesApi=Object.hasOwn(t,"disableChangesApi")?t.disableChangesApi:!0,this.disableDeltaChangesApi=Object.hasOwn(t,"disableDeltaChangesApi")?t.disableDeltaChangesApi:!0,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=Object.hasOwn(t,"autoupdate")?t.autoupdate:!1,this.serializableIndices=Object.hasOwn(t,"serializableIndices")?t.serializableIndices:!0,this.disableFreeze=Object.hasOwn(t,"disableFreeze")?t.disableFreeze:!0,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(t.ttl||-1,t.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[];let r=[];if(t&&t.indices)if(Object.prototype.toString.call(t.indices)==="[object Array]")r=t.indices;else if(typeof t.indices=="string")r=[t.indices];else throw new TypeError("Indices needs to be a string or an array of strings");for(let h=0;h<r.length;h++)this.ensureIndex(r[h]);function n(h){let d=new Set;d.add||(d.add=function(p){return this.includes(p)||this.push(p),this}),h.forEach(({object:p})=>{d.add(p)}),d.forEach(p=>{if(!j.call(p,"$loki"))return i.removeAutoUpdateObserver(p);try{i.update(p)}catch(f){console.log(f)}})}u(n,"observerCallback"),this.observerCallback=n;function l(h,d){return d?o(d,h):JSON.parse(JSON.stringify(h))}u(l,"getChangeDelta"),this.getChangeDelta=l;function o(h,d){let p=d!==null&&typeof d=="object"?Object.keys(d):null;if(p&&p.length&&!["string","boolean","number"].includes(typeof d)){let f={};for(let m=0;m<p.length;m++){let g=p[m];if(g in d)if(!(g in h)||i.uniqueNames.includes(g)||g=="$loki"||g=="meta")f[g]=d[g];else{let S=o(h[g],d[g]);typeof S!="undefined"&&(f[g]=S)}}return Object.keys(f).length===0?void 0:f}else return h===d?void 0:d}u(o,"getObjectDelta"),this.getObjectDelta=o;function c(){i.changes=[]}u(c,"flushChanges"),this.getChanges=()=>i.changes,this.flushChanges=c,this.setChangesApi=h=>{i.disableChangesApi=!h,h||(i.disableDeltaChangesApi=!1)},this.on("delete",u(function(d){i.disableChangesApi||i.createChange(i.name,"R",d)},"deleteCallback")),this.on("warning",h=>{i.lokiConsoleWrapper.warn(h)}),c()}createChange(e,t,i,r){this.changes.push({name:e,operation:t,obj:t=="U"&&!this.disableDeltaChangesApi?this.getChangeDelta(i,r):JSON.parse(JSON.stringify(i))})}insertMeta(e){let t,i;if(!(this.disableMeta||!e)){if(Array.isArray(e)){for(t=e.length,i=0;i<t;i++)"meta"in e[i]||(e[i].meta={}),e[i].meta.created=new Date().getTime(),e[i].meta.revision=0;return}e.meta||(e.meta={}),e.meta.created=new Date().getTime(),e.meta.revision=0}}updateMeta(e){return this.disableMeta||!e||(this.disableFreeze||(e=W(e),e.meta=W(e.meta)),e.meta.updated=new Date().getTime(),e.meta.revision+=1),e}createInsertChange(e){this.createChange(this.name,"I",e)}createUpdateChange(e,t){this.createChange(this.name,"U",e,t)}insertMetaWithChange(e){this.insertMeta(e),this.createInsertChange(e)}updateMetaWithChange(e,t){return e=this.updateMeta(e),this.createUpdateChange(e,t),e}addAutoUpdateObserver(e){!this.autoupdate||typeof Object.observe!="function"||Object.observe(e,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(e){!this.autoupdate||typeof Object.observe!="function"||Object.unobserve(e,this.observerCallback)}addTransform(e,t){if(e in this.transforms)throw new Error("a transform by that name already exists");this.transforms[e]=t}getTransform(e){return this.transforms[e]}setTransform(e,t){this.transforms[e]=t}removeTransform(e){delete this.transforms[e]}byExample(e){let t,i,r=[];for(t in e)t in e&&r.push((i={},i[t]=e[t],i));return{$and:r}}findObject(e){return this.findOne(this.byExample(e))}findObjects(e){return this.find(this.byExample(e))}ttlDaemonFuncGen(){let e=this,t=this.ttl.age;return u(function(){let r=Date.now();e.chain().where(u(function(o){let c=o.meta.updated||o.meta.created,h=r-c;return t<h},"daemonFilter")).remove()},"ttlDaemon")}setTTL(e,t){e<0?clearInterval(this.ttl.daemon):(this.ttl.age=e,this.ttl.ttlInterval=t,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),t))}prepareFullDocIndex(){let e=this.data.length,t=new Array(e);for(let i=0;i<e;i+=1)t[i]=i;return t}ensureIndex(e,t){if(typeof t=="undefined"&&(t=!1),e==null)throw new Error("Attempting to set index without an associated property");if(this.binaryIndices[e]&&!t&&!this.binaryIndices[e].dirty||this.adaptiveBinaryIndices===!0&&e in this.binaryIndices&&!t)return;let i={name:e,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[e]=i;let r=((n,l)=>{let o,c,h=~n.indexOf(".")?n.split("."):!1;return(d,p)=>{if(h?(o=y.getIn(l[d],h,!0),c=y.getIn(l[p],h,!0)):(o=l[d][n],c=l[p][n]),o!==c){if(b.lt(o,c,!1))return-1;if(b.gt(o,c,!1))return 1}return 0}})(e,this.data);i.values.sort(r),i.dirty=!1,this.dirty=!0}checkAllIndexes(e){let t,i=this.binaryIndices,r=[],n;for(t in i)j.call(i,t)&&(n=this.checkIndex(t,e),n||r.push(t));return r}checkIndex(e,t={}){t.randomSamplingFactor&&t.randomSampling!==!1&&(t.randomSampling=!0),t.randomSamplingFactor=t.randomSamplingFactor||.1,(t.randomSamplingFactor<0||t.randomSamplingFactor>1)&&(t.randomSamplingFactor=.1);let i=!0,r,n,l;if(!(e in this.binaryIndices))throw new Error(`called checkIndex on property without an index: ${e}`);this.adaptiveBinaryIndices||this.ensureIndex(e);let o=this.binaryIndices[e].values,c=o.length;if(c!==this.data.length)return t.repair&&this.ensureIndex(e,!0),!1;if(c===0)return!0;let h=e.includes(".");if(c===1)i=o[0]===0;else if(t.randomSampling){if(A.$lte(y.getIn(this.data[o[0]],e,h),y.getIn(this.data[o[1]],e,h))||(i=!1),A.$lte(y.getIn(this.data[o[c-2]],e,h),y.getIn(this.data[o[c-1]],e,h))||(i=!1),i){for(n=Math.floor((c-1)*t.randomSamplingFactor),r=0;r<n-1;r++)if(l=Math.floor(Math.random()*(c-1)),!A.$lte(y.getIn(this.data[o[l]],e,h),y.getIn(this.data[o[l+1]],e,h))){i=!1;break}}}else for(r=0;r<c-1;r++)if(!A.$lte(y.getIn(this.data[o[r]],e,h),y.getIn(this.data[o[r+1]],e,h))){i=!1;break}return!i&&t.repair&&this.ensureIndex(e,!0),i}getBinaryIndexValues(e){let t,i=this.binaryIndices[e].values,r=[];for(t=0;t<i.length;t++)r.push(y.getIn(this.data[i[t]],e,!0));return r}getUniqueIndex(e,t){let i=this.constraints.unique[e];return!i&&t?this.ensureUniqueIndex(e):i}ensureUniqueIndex(e){let t=this.constraints.unique[e];return t||this.uniqueNames.includes(e)||this.uniqueNames.push(e),this.constraints.unique[e]=t=new Z(e),this.data.forEach(i=>{t.set(i)}),t}ensureAllIndexes(e){let t=this.binaryIndices;for(let i in t)j.call(t,i)&&this.ensureIndex(i,e)}flagBinaryIndexesDirty(){let e=this.binaryIndices;for(let t in e)j.call(e,t)&&(e[t].dirty=!0)}flagBinaryIndexDirty(e){this.binaryIndices[e]&&(this.binaryIndices[e].dirty=!0)}ensureId(){if(this.idIndex)return;let e=this.data,t=0,i=e.length,r=new Array(i);for(t;t<i;t++)r[t]=e[t].$loki;this.idIndex=r}ensureIdAsync(e){this.async(function(){this.ensureId()},e)}addDynamicView(e,t){let i=new ce(this,e,t);return this.DynamicViews.push(i),i}removeDynamicView(e){this.DynamicViews=this.DynamicViews.filter(t=>t.name!==e)}getDynamicView(e){for(let t=0;t<this.DynamicViews.length;t++)if(this.DynamicViews[t].name===e)return this.DynamicViews[t];return null}findAndUpdate(e,t){typeof e=="function"?this.updateWhere(e,t):this.chain().find(e).update(t)}findAndRemove(e){this.chain().find(e).remove()}insert(e,t){if(!Array.isArray(e))return this.insertOne(e);let i,r=[],n=t&&!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;n&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",e);for(let l=0,o=e.length;l<o;l++){if(i=this.insertOne(e[l],!0),!i)return;r.push(i)}}finally{n&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",r),r=this.cloneObjects?I(r,this.cloneMethod):r,r.length===1?r[0]:r}insertOne(e,t){let i=null;if(typeof e!="object"?i=new TypeError("Document needs to be an object"):e===null&&(i=new TypeError("Object cannot be null")),i!==null)throw this.emit("error",i),i;let r=this.cloneObjects?I(e,this.cloneMethod):e;if(this.disableFreeze||(r=W(r)),this.disableMeta||(typeof r.meta=="undefined"?r.meta={revision:0,created:0}:this.disableFreeze||(r.meta=W(r.meta))),t||this.emit("pre-insert",r),!this.add(r))return;this.disableChangesApi?this.insertMeta(r):this.insertMetaWithChange(r),this.disableFreeze||C(r);let n=this.cloneObjects?I(r,this.cloneMethod):r;return t||this.emit("insert",n),this.addAutoUpdateObserver(n),n}clear(e){let t=this;e=e||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},e.removeIndices===!0?(this.binaryIndices={},this.uniqueNames=[]):Object.keys(this.binaryIndices).forEach(r=>{t.binaryIndices[r].dirty=!1,t.binaryIndices[r].values=[]})}update(e){let t,i,r;if(Array.isArray(e)){r=e.length,t=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,t&&(this.adaptiveBinaryIndices=!1);try{for(i=0;i<r;i+=1)this.update(e[i])}finally{t&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return}if(!j.call(e,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();let n=this.get(e.$loki,!0),l,o=this;if(!n)throw new Error("Trying to update a document not in collection.");let c=n[0],h=n[1];l=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?I(e,this.cloneMethod):e,this.emit("pre-update",e),this.uniqueNames.forEach(f=>{o.getUniqueIndex(f,!0).update(c,l)}),this.data[h]=l,l!==e&&this.addAutoUpdateObserver(e);for(let f=0;f<this.DynamicViews.length;f++)this.DynamicViews[f].evaluateDocument(h,!1);let d;if(this.adaptiveBinaryIndices){let f=this.binaryIndices;for(d in f)this.adaptiveBinaryIndexUpdate(h,d)}else this.flagBinaryIndexesDirty();this.idIndex[h]=l.$loki,this.isIncremental&&this.dirtyIds.push(l.$loki),this.commit(),this.dirty=!0,this.disableChangesApi?l=this.updateMeta(l):l=this.updateMetaWithChange(l,c),this.disableFreeze||C(l);let p;return this.cloneObjects?p=I(l,this.cloneMethod):p=l,this.emit("update",p),p}catch(n){throw this.rollback(),this.lokiConsoleWrapper.error(n.message),this.emit("error",n),n}}add(e){if(typeof e!="object")throw new TypeError("Object being added needs to be an object");if(typeof e.$loki!="undefined")throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);let t=this.maxId;e.$loki=t,this.disableMeta||(e.meta.version=0);for(let n=0,l=this.uniqueNames.length;n<l;n++)this.getUniqueIndex(this.uniqueNames[n],!0).set(e);this.idIndex&&this.idIndex.push(t),this.isIncremental&&this.dirtyIds.push(t),this.data.push(e);let i=this.data.length-1,r=this.DynamicViews.length;for(let n=0;n<r;n++)this.DynamicViews[n].evaluateDocument(i,!0);if(this.adaptiveBinaryIndices){let n=this.binaryIndices;for(let l in n)this.adaptiveBinaryIndexInsert(i,l)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?I(e,this.cloneMethod):e}catch(t){throw this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),t}}updateWhere(e,t){let i=this.where(e),r=0,n;try{for(r;r<i.length;r++)n=t(i[r]),this.update(n)}catch(l){this.rollback(),this.lokiConsoleWrapper.error(l.message)}}removeWhere(e){let t;typeof e=="function"?(t=this.data.filter(e),this.remove(t)):this.chain().find(e).remove()}removeDataOnly(){this.remove(this.data.slice())}removeBatchByPositions(e){let t=e.length,i={},r,n,l,o=Object.keys(this.binaryIndices).length,c=Object.keys(this.constraints.unique).length,h=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,d,p=this;try{for(this.startTransaction(),this.ensureId(),l=0;l<t;l++)i[this.idIndex[e[l]]]=!0;if(r=this.DynamicViews.length,r>0||o>0||c>0){if(r>0)for(n=0;n<r;n++)this.DynamicViews[n].removeDocument(e);if(this.adaptiveBinaryIndices&&!h){let f,m=this.binaryIndices;for(f in m)this.adaptiveBinaryIndexRemove(e,f)}else this.flagBinaryIndexesDirty();c&&this.uniqueNames.forEach(f=>{let m=p.getUniqueIndex(f);if(m)for(l=0;l<t;l++)d=p.data[e[l]],d[f]!==null&&d[f]!==void 0&&m.remove(d[f])})}if(!this.disableChangesApi||this.events.delete.length>1)for(l=0;l<t;l++)this.emit("delete",this.data[e[l]]);if(this.data=this.data.filter(({$loki:f})=>!i[f]),this.isIncremental)for(l=0;l<t;l++)this.dirtyIds.push(this.idIndex[e[l]]);this.idIndex=this.idIndex.filter(f=>!i[f]),this.adaptiveBinaryIndices&&h&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(f){return this.rollback(),h&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(f.message),this.emit("error",f),null}}removeBatch(e){let t=e.length,i=this.data.length,r,n={},l=[];for(r=0;r<i;r++)n[this.data[r].$loki]=r;for(r=0;r<t;r++)typeof e[r]=="object"?l.push(n[e[r].$loki]):l.push(n[e[r]]);this.removeBatchByPositions(l)}remove(e){let t;if(typeof e=="number"?t=this.get(e):t=e,typeof t!="object")throw new Error("Parameter is not an object");if(Array.isArray(t)){this.removeBatch(t);return}if(!j.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();let i=this.get(t.$loki,!0),r=i[1],n=this;this.uniqueNames.forEach(l=>{if(t[l]!==null&&typeof t[l]!="undefined"){let o=n.getUniqueIndex(l);o&&o.remove(t[l])}});for(let l=0;l<this.DynamicViews.length;l++)this.DynamicViews[l].removeDocument(r);if(this.adaptiveBinaryIndices){let l,o=this.binaryIndices;for(l in o)this.adaptiveBinaryIndexRemove(r,l)}else this.flagBinaryIndexesDirty();return this.data.splice(r,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(r,1),this.isIncremental&&this.dirtyIds.push(t.$loki),this.commit(),this.dirty=!0,this.emit("delete",i[0]),this.disableFreeze||(t=W(t)),delete t.$loki,delete t.meta,this.disableFreeze||J(t),t}catch(i){return this.rollback(),this.lokiConsoleWrapper.error(i.message),this.emit("error",i),null}}get(e,t){this.idIndex||this.ensureId();let i=t||!1,r=this.idIndex,n=r.length-1,l=0,o=l+n>>1;if(e=typeof e=="number"?e:parseInt(e,10),isNaN(e))throw new TypeError("Passed id is not an integer");for(;r[l]<r[n];)o=l+n>>1,r[o]<e?l=o+1:n=o;return n===l&&r[l]===e?i?[this.data[l],l]:this.data[l]:null}getBinaryIndexPosition(e,t){let i=y.getIn(this.data[e],t,!0),r=this.binaryIndices[t].values,n=this.calculateRange("$eq",t,i);if(n[0]===0&&n[1]===-1)return null;let l=n[0],o=n[1];for(let c=l;c<=o;c++)if(r[c]===e)return c;return null}adaptiveBinaryIndexInsert(e,t){let i=t.includes("."),r=this.binaryIndices[t].values,n=y.getIn(this.data[e],t,i);this.serializableIndices===!0&&n instanceof Date&&(this.data[e][t]=n.getTime(),n=y.getIn(this.data[e],t));let l=r.length===0?0:this.calculateRangeStart(t,n,!0,i);this.binaryIndices[t].values.splice(l,0,e)}adaptiveBinaryIndexUpdate(e,t){let i,r=this.binaryIndices[t].values,n=r.length;for(i=0;i<n&&r[i]!==e;i++);this.binaryIndices[t].values.splice(i,1),this.adaptiveBinaryIndexInsert(e,t)}adaptiveBinaryIndexRemove(e,t,i){let r=this.binaryIndices[t],n,l,o,c,h={},d,p;if(Array.isArray(e))if(c=e.length,c===1)e=e[0];else{for(o=0;o<c;o++)h[e[o]]=!0;if(r.values=r.values.filter(g=>!h[g]),i===!0)return;let m=e.slice();for(m.sort((g,S)=>g-S),n=r.values.length,l=0;l<n;l++){for(d=r.values[l],p=0,o=0;o<c&&d>m[o];o++)p++;r.values[l]-=p}return}let f=this.getBinaryIndexPosition(e,t);if(f===null)return null;if(r.values.splice(f,1),i!==!0)for(n=r.values.length,l=0;l<n;l++)r.values[l]>e&&r.values[l]--}calculateRangeStart(e,t,i,r){let n=this.data,l=this.binaryIndices[e].values,o=0,c=l.length-1,h=0;if(l.length===0)return-1;for(;o<c;)h=o+c>>1,b.lt(y.getIn(n[l[h]],e,r),t,!1)?o=h+1:c=h;let d=o;return b.aeq(t,y.getIn(n[l[d]],e,r))?d:b.lt(t,y.getIn(n[l[d]],e,r),!1)?i?d:d-1:i?d+1:d}calculateRangeEnd(e,t,i){let r=this.data,n=this.binaryIndices[e].values,l=0,o=n.length-1,c=0;if(n.length===0)return-1;for(;l<o;)c=l+o>>1,b.lt(t,y.getIn(r[n[c]],e,i),!1)?o=c:l=c+1;let h=o;return b.aeq(t,y.getIn(r[n[h]],e,i))?h:b.gt(t,y.getIn(r[n[h]],e,i),!1)?h+1:b.aeq(t,y.getIn(r[n[h-1]],e,i))?h-1:h}calculateRange(e,t,i){let r=this.data,n=this.binaryIndices[t].values,l=0,o=n.length-1,c,h,d,p;if(r.length===0)return[0,-1];let f=t.includes("."),m=y.getIn(r[n[l]],t,f),g=y.getIn(r[n[o]],t,f);switch(e){case"$eq":case"$aeq":if(b.lt(i,m,!1)||b.gt(i,g,!1))return[0,-1];break;case"$dteq":if(b.lt(i,m,!1)||b.gt(i,g,!1))return[0,-1];break;case"$gt":if(b.gt(i,g,!0))return[0,-1];if(b.gt(m,i,!1))return[l,o];break;case"$gte":if(b.gt(i,g,!1))return[0,-1];if(b.gt(m,i,!0))return[l,o];break;case"$lt":if(b.lt(i,m,!0))return[0,-1];if(b.lt(g,i,!1))return[l,o];break;case"$lte":if(b.lt(i,m,!1))return[0,-1];if(b.lt(g,i,!0))return[l,o];break;case"$between":return b.gt(i[0],g,!1)?[0,-1]:b.lt(i[1],m,!1)?[0,-1]:(c=this.calculateRangeStart(t,i[0],!1,f),d=this.calculateRangeEnd(t,i[1],f),c<0&&c++,d>o&&d--,b.gt(y.getIn(r[n[c]],t,f),i[0],!0)||c++,b.lt(y.getIn(r[n[d]],t,f),i[1],!0)||d--,d<c?[0,-1]:[c,d]);case"$in":{let S=[],R=[];for(let F=0,v=i.length;F<v;F++){let z=this.calculateRange("$eq",t,i[F]);for(let M=z[0];M<=z[1];M++)S[M]===void 0&&(S[M]=!0,R.push(M))}return R}}switch(e){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":c=this.calculateRangeStart(t,i,!1,f),h=y.getIn(r[n[c]],t,f);break;default:break}switch(e){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":d=this.calculateRangeEnd(t,i,f),p=y.getIn(r[n[d]],t,f);break;default:break}switch(e){case"$eq":case"$aeq":case"$dteq":return b.aeq(h,i)?[c,d]:[0,-1];case"$gt":return b.aeq(y.getIn(r[n[d]],t,f),i)?[d+1,o]:[d,o];case"$gte":return b.aeq(y.getIn(r[n[c]],t,f),i)?[c,o]:[c+1,o];case"$lt":return b.aeq(y.getIn(r[n[c]],t,f),i)?[l,c-1]:[l,c];case"$lte":return b.aeq(y.getIn(r[n[d]],t,f),i)?[l,d]:[l,d-1];default:return[0,r.length-1]}}by(e,t){let i;if(t===void 0)return i=this,n=>i.by(e,n);let r=this.getUniqueIndex(e,!0).get(t);return this.cloneObjects?I(r,this.cloneMethod):r}findOne(e={}){let t=this.chain().find(e,!0).data();return Array.isArray(t)&&t.length===0?null:this.cloneObjects?I(t[0],this.cloneMethod):t[0]}chain(e,t){let i=new x(this);return typeof e=="undefined"?i:i.transform(e,t)}find(e){return this.chain().find(e).data()}findOneUnindexed(e,t){let i=this.data.length,r;for(;i--;)if(y.getIn(this.data[i],e,!0)===t)return r=this.data[i],r;return null}async(e,t){setTimeout(()=>{if(typeof e=="function")e(),t();else throw new TypeError("Argument passed for async execution is not a function")},0)}where(e){return this.chain().where(e).data()}eqJoin(e,t,i,r,n){return new x(this).eqJoin(e,t,i,r,n)}getStage(e){return this.stages[e]||(this.stages[e]={}),this.stages[e]}stage(e,t){let i=JSON.parse(JSON.stringify(t));return this.getStage(e)[t.$loki]=i,i}commitStage(e,t){let i=this.getStage(e),r,n=new Date().getTime();for(r in i)this.update(i[r]),this.commitLog.push({timestamp:n,message:t,data:JSON.parse(JSON.stringify(i[r]))});this.stages[e]={}}extract(e){let t=0,i=this.data.length,r=le(e),n=[];for(t;t<i;t+=1)n.push(V(this.data[t],e,r));return n}max(e){return Math.max.apply(null,this.extract(e))}min(e){return Math.min.apply(null,this.extract(e))}maxRecord(e){let t=0,i=this.data.length,r=le(e),n={index:0,value:void 0},l;for(t;t<i;t+=1)l!==void 0?l<V(this.data[t],e,r)&&(l=V(this.data[t],e,r),n.index=this.data[t].$loki):(l=V(this.data[t],e,r),n.index=this.data[t].$loki);return n.value=l,n}minRecord(e){let t=0,i=this.data.length,r=le(e),n={index:0,value:void 0},l;for(t;t<i;t+=1)l!==void 0?l>V(this.data[t],e,r)&&(l=V(this.data[t],e,r),n.index=this.data[t].$loki):(l=V(this.data[t],e,r),n.index=this.data[t].$loki);return n.value=l,n}extractNumerical(e){return this.extract(e).map(Ee).filter(Number).filter(t=>!isNaN(t))}avg(e){return ae(this.extractNumerical(e))}stdDev(e){return Re(this.extractNumerical(e))}mode(e){let t={};this.extract(e).forEach(o=>{t[o]?t[o]+=1:t[o]=1});let r,n,l;for(n in t)r?r<t[n]&&(l=n):(l=n,r=t[n]);return l}median(e){let t=this.extractNumerical(e);t.sort(Te);let i=Math.floor(t.length/2);return t.length%2?t[i]:(t[i-1]+t[i])/2}};u(T,"Collection");function xe(a,s,e){for(var t=0,i=a.length,r,n;t<i;){if(n=t+i>>1,r=e.apply(null,[s,a[n]]),r===0)return{found:!0,index:n};r<0?i=n:t=n+1}return{found:!1,index:i}}u(xe,"binarySearch");function De(a){return function(s,e){return xe(s,e,a)}}u(De,"BSonSort");function Ce(){}u(Ce,"KeyValueStore");Ce.prototype={keys:[],values:[],sort(a,s){return a<s?-1:a>s?1:0},setSort(a){this.bs=De(a)},bs(){return De(this.sort)},set(a,s){let e=this.bs(this.keys,a);e.found?this.values[e.index]=s:(this.keys.splice(e.index,0,a),this.values.splice(e.index,0,s))},get(a){return this.values[xe(this.keys,a,this.sort).index]}};function he(){try{return window&&window.localStorage!==void 0&&window.localStorage!==null}catch(a){return!1}}u(he,"localStorageAvailable");var Q=class{loadDatabase(s,e){he()?e(localStorage.getItem(s)):e(new Error("localStorage is not available"))}saveDatabase(s,e,t){he()?(localStorage.setItem(s,e),t(null)):t(new Error("localStorage is not available"))}deleteDatabase(s,e){he()?(localStorage.removeItem(s),e(null)):e(new Error("localStorage is not available"))}};u(Q,"LocalStorageAdapter");var ee=class{constructor(s){this.hashStore={},this.options=s||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}loadDatabase(s,e){let t=this;this.options.asyncResponses?setTimeout(()=>{t.hashStore.hasOwnProperty(s)?e(t.hashStore[s].value):e(null)},this.options.asyncTimeout):this.hashStore.hasOwnProperty(s)?e(this.hashStore[s].value):e(null)}saveDatabase(s,e,t){let i=this,r;this.options.asyncResponses?setTimeout(()=>{r=i.hashStore.hasOwnProperty(s)?i.hashStore[s].savecount:0,i.hashStore[s]={savecount:r+1,lastsave:new Date,value:e},t()},this.options.asyncTimeout):(r=this.hashStore.hasOwnProperty(s)?this.hashStore[s].savecount:0,this.hashStore[s]={savecount:r+1,lastsave:new Date,value:e},t())}deleteDatabase(s,e){this.hashStore.hasOwnProperty(s)&&delete this.hashStore[s],typeof e=="function"&&e()}};u(ee,"MemoryAdapter");function K(a,s){if(this.mode="reference",this.adapter=null,this.options=s||{},this.dbref=null,this.dbname="",this.pageIterator={},a){if(a.mode==="reference")throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=a}else throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=25*1024*1024),this.options.hasOwnProperty("delimiter")||(this.options.delimiter=`$<
`)}u(K,"PartitioningAdapter");K.prototype.loadDatabase=function(a,s){var e=this;this.dbname=a,this.dbref=new te(a),this.adapter.loadDatabase(a,function(t){if(!t){s(t);return}typeof t!="string"&&s(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var i=JSON.parse(t);if(e.dbref.loadJSONObject(i),i=null,e.dbref.collections.length===0){s(e.dbref);return}e.pageIterator={collection:0,pageIndex:0},e.loadNextPartition(0,function(){s(e.dbref)})})};K.prototype.loadNextPartition=function(a,s){var e=this.dbname+"."+a,t=this;if(this.options.paging===!0){this.pageIterator.pageIndex=0,this.loadNextPage(s);return}this.adapter.loadDatabase(e,function(i){var r=t.dbref.deserializeCollection(i,{delimited:!0,collectionIndex:a});t.dbref.collections[a].data=r,++a<t.dbref.collections.length?t.loadNextPartition(a,s):s()})};K.prototype.loadNextPage=function(a){var s=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,e=this;this.adapter.loadDatabase(s,function(t){var i=t.split(e.options.delimiter);t="";var r=i.length,n,l=i[r-1]==="";for(l&&(i.pop(),r=i.length,i[r-1]===""&&r===1&&(i.pop(),r=i.length)),n=0;n<r;n++)e.dbref.collections[e.pageIterator.collection].data.push(JSON.parse(i[n])),i[n]=null;i=[],l?++e.pageIterator.collection<e.dbref.collections.length?e.loadNextPartition(e.pageIterator.collection,a):a():(e.pageIterator.pageIndex++,e.loadNextPage(a))})};K.prototype.exportDatabase=function(a,s,e){var t,i=s.collections.length;for(this.dbref=s,this.dbname=a,this.dirtyPartitions=[-1],t=0;t<i;t++)s.collections[t].dirty&&this.dirtyPartitions.push(t);this.saveNextPartition(function(r){e(r)})};K.prototype.saveNextPartition=function(a){var s=this,e=this.dirtyPartitions.shift(),t=this.dbname+(e===-1?"":"."+e);if(this.options.paging&&e!==-1){this.pageIterator={collection:e,docIndex:0,pageIndex:0},this.saveNextPage(function(r){s.dirtyPartitions.length===0?a(r):s.saveNextPartition(a)});return}var i=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:e});this.adapter.saveDatabase(t,i,function(r){if(r){a(r);return}s.dirtyPartitions.length===0?a(null):s.saveNextPartition(a)})};K.prototype.saveNextPage=function(a){var s=this,e=this.dbref.collections[this.pageIterator.collection],t=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,i=0,r=e.data.length,n=this.options.delimiter.length,l="",o="",c=!1,h=!1,d=u(function(f){o="",f&&a(f),c?a(null):(s.pageIterator.pageIndex++,s.saveNextPage(a))},"pageSaveCallback");e.data.length===0&&(c=!0);let p=!1;for(;!p;)c||(l=JSON.stringify(e.data[this.pageIterator.docIndex]),o+=l,i+=l.length,++this.pageIterator.docIndex>=r&&(c=!0)),i>=this.options.pageSize&&(h=!0),(!h||c)&&(o+=this.options.delimiter,i+=n),(c||h)&&(this.adapter.saveDatabase(t,o,d),p=!0)};var w=class extends B{constructor(e,t){super();this.loadDatabaseInternal=u((e,t)=>{let i=t||(o=>{if(o)throw o}),r=u(o=>{let c=!1;try{this.loadJSON(o,e||{}),c=!0}catch(h){i(h)}c&&(i(null),this.emit("loaded",`database ${this.filename} loaded`))},"handleValidDbString"),n=u(o=>{if(!o){i(null),this.emit("loaded",`empty database ${this.filename} loaded`);return}if(o instanceof Error){i(o);return}if(typeof o=="object"){this.loadJSONObject(o,e||{}),i(null),this.emit("loaded",`database ${this.filename} loaded`);return}i({success:!1,error:Error(`unexpected adapter response : ${o}`)})},"handleLoadError"),l=u(o=>{typeof o=="string"?r(o):n(o)},"loadDatabaseCallback");this.persistenceAdapter!==null?"isAsync"in this.persistenceAdapter?this.persistenceAdapter.loadDatabaseAsync(this.filename).then(o=>r(o)).catch(o=>n(o)):this.persistenceAdapter.loadDatabase(this.filename,l):i(new Error("persistenceAdapter not configured"))},"loadDatabaseInternal");this.filename=e||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=t&&Object.hasOwn(t,"verbose")?t.verbose:!1,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};let i=u(()=>typeof global!="undefined"&&(global.android||global.NSObject)?"NATIVESCRIPT":typeof window=="undefined"||typeof global!="undefined"&&global.window&&typeof process!="undefined"?"NODEJS":typeof document!="undefined"?!document.URL.includes("http://")&&!document.URL.includes("https://")?"CORDOVA":"BROWSER":"CORDOVA","getENV");t&&Object.hasOwn(t,"env")?this.ENV=t.env:this.ENV=i(),this.ENV==="undefined"&&(this.ENV="NODEJS"),this.configureOptions(t,!0),this.on("init",this.clearChanges)}getIndexedAdapter(){return Promise.resolve().then(()=>(je(),qe))}configureOptions(e,t){let i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"},r={fs:H,localStorage:Q,memory:ee};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,typeof e!="undefined"){if(this.options=e,Object.hasOwn(this.options,"persistenceMethod")&&typeof r[e.persistenceMethod]=="function"&&(this.persistenceMethod=e.persistenceMethod,this.persistenceAdapter=new r[e.persistenceMethod]),Object.hasOwn(this.options,"adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=e.adapter,this.options.adapter=null,this.isIncremental=this.persistenceAdapter.mode==="incremental"),e.autoload&&t){let n=this;setTimeout(()=>{n.loadDatabase(e,e.autoloadCallback)},1)}Object.hasOwn(this.options,"autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),Object.hasOwn(this.options,"autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,Object.hasOwn(this.options,"autosaveCallback")?this.autosaveEnable(e,e.autosaveCallback):this.autosaveEnable()),Object.hasOwn(this.options,"throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}Object.hasOwn(this.options,"serializationMethod")||(this.options.serializationMethod="normal"),Object.hasOwn(this.options,"destructureDelimiter")||(this.options.destructureDelimiter=`$<
`),this.persistenceAdapter===null&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new r[this.persistenceMethod]))}copy(e){let t=new w(this.filename,{env:"NA"}),i,r;if(e=e||{},t.loadJSONObject(this,{retainDirtyFlags:!0}),e.hasOwnProperty("removeNonSerializable")&&e.removeNonSerializable===!0)for(t.autosaveHandle=null,t.persistenceAdapter=null,i=t.collections.length,r=0;r<i;r++)t.collections[r].constraints=null,t.collections[r].ttl=null;return t}addCollection(e,t){let i,r=this.collections.length;if(t&&t.disableMeta===!0){if(t.disableChangesApi===!1)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(t.disableDeltaChangesApi===!1)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if(typeof t.ttl=="number"&&t.ttl>0)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<r;i+=1)if(this.collections[i].name===e)return this.collections[i];let n=new T(e,t);return n.isIncremental=this.isIncremental,this.collections.push(n),this.verbose&&(n.lokiConsoleWrapper=console),n}loadCollection(e){if(!e.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(e)}getCollection(e){let t,i=this.collections.length;for(t=0;t<i;t+=1)if(this.collections[t].name===e)return this.collections[t];return this.emit("warning",`collection ${e} not found`),null}renameCollection(e,t){let i=this.getCollection(e);return i&&(i.name=t),i}listCollections(){let e=this.collections.length,t=[];for(;e--;)t.push({name:this.collections[e].name,type:this.collections[e].objType,count:this.collections[e].data.length});return t}removeCollection(e){let t,i=this.collections.length;for(t=0;t<i;t+=1)if(this.collections[t].name===e){let r=new T(e,{}),n=this.collections[t];for(let l in n)n.hasOwnProperty(l)&&r.hasOwnProperty(l)&&(n[l]=r[l]);this.collections.splice(t,1);return}}getName(){return this.name}serializeReplacer(e,t){switch(e){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return;case"lokiConsoleWrapper":return null;default:return t}}serialize(e={}){switch(e.hasOwnProperty("serializationMethod")||(e.serializationMethod=this.options.serializationMethod),e.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}}serializeDestructured(e){let t,i,r,n,l=[],o;if(e=e||{},e.hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned===!0&&e.hasOwnProperty("partition")&&e.partition>=0)return this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:e.partition});for(o=new w(this.filename),o.loadJSONObject(this),t=0;t<o.collections.length;t++)o.collections[t].data=[];if(e.partitioned===!0&&e.partition===-1)return o.serialize({serializationMethod:"normal"});for(l.push(o.serialize({serializationMethod:"normal"})),o=null,t=0;t<this.collections.length;t++)if(r=this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:t}),e.partitioned===!1&&e.delimited===!1){if(!Array.isArray(r))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(n=r.length,i=0;i<n;i++)l.push(r[i]),r[i]=null;l.push("")}else l.push(r);return e.partitioned?(e.delimited,l):e.delimited?(l.push(""),l.join(e.delimiter)):(l.push(""),l)}serializeCollection(e){let t,i=[];if(e=e||{},e.hasOwnProperty("delimited")||(e.delimited=!0),!e.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");let r=this.collections[e.collectionIndex].data.length;for(i=[],t=0;t<r;t++)i.push(JSON.stringify(this.collections[e.collectionIndex].data[t]));return e.delimited?(i.push(""),i.join(e.delimiter)):i}deserializeDestructured(e,t){let i=[],r,n,l=0,o,c=1,h=!1,d,p;if(t=t||{},t.hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.partitioned){if(t.hasOwnProperty("partition"))return t.partition===-1?(n=JSON.parse(e[0]),n):this.deserializeCollection(e[t.partition+1],t);for(n=JSON.parse(e[0]),o=n.collections.length,l=0;l<o;l++)n.collections[l].data=this.deserializeCollection(e[l+1],t);return n}if(t.delimited){if(i=e.split(t.delimiter),e=null,r=i.length,r===0)return null}else i=e;for(n=JSON.parse(i[0]),o=n.collections.length,i[0]=null;!h;)d=i[c],i[c]===""?++l>o&&(h=!0):(p=JSON.parse(i[c]),n.collections[l].data.push(p)),i[c++]=null;return n}deserializeCollection(e,t){let i=[],r;t=t||{},t.hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.delimited?(i=e.split(t.delimiter),i.pop()):i=e;let n=i.length;for(r=0;r<n;r++)i[r]=JSON.parse(i[r]);return i}loadJSON(e,t){let i;if(e.length===0)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(e);break;case"destructured":i=this.deserializeDestructured(e);break;default:i=JSON.parse(e);break}this.loadJSONObject(i,t)}loadJSONObject(e,t){let i=0,r=e.collections?e.collections.length:0,n,l,o,c,h,d;this.name=e.name,e.hasOwnProperty("throttledSaves")&&t&&!t.hasOwnProperty("throttledSaves")&&(this.throttledSaves=e.throttledSaves),this.collections=[];function p({name:f}){let m=t[f],g;return m.proto?(g=m.inflate||y.copyProperties,S=>{let R=new m.proto;return g(S,R),R}):m.inflate}for(u(p,"makeLoader"),i;i<r;i+=1){if(n=e.collections[i],l=this.addCollection(n.name,{disableChangesApi:n.disableChangesApi,disableDeltaChangesApi:n.disableDeltaChangesApi,disableMeta:n.disableMeta,disableFreeze:n.hasOwnProperty("disableFreeze")?n.disableFreeze:!0}),l.adaptiveBinaryIndices=n.hasOwnProperty("adaptiveBinaryIndices")?n.adaptiveBinaryIndices===!0:!1,l.transactional=n.transactional,l.asyncListeners=n.asyncListeners,l.cloneObjects=n.cloneObjects,l.cloneMethod=n.cloneMethod||"parse-stringify",l.autoupdate=n.autoupdate,l.changes=n.changes,l.dirtyIds=n.dirtyIds||[],t&&t.retainDirtyFlags===!0?l.dirty=n.dirty:l.dirty=!1,n.getData){if(t&&t.hasOwnProperty(n.name)||!l.disableFreeze||l.autoupdate)throw new Error(`this collection cannot be loaded lazily: ${n.name}`);l.getData=n.getData,Object.defineProperty(l,"data",{get(){let f=this.getData();return this.getData=null,Object.defineProperty(this,"data",{value:f}),f}})}else if(o=n.data.length,c=0,t&&t.hasOwnProperty(n.name))for(h=p(n),c;c<o;c++)d=h(n.data[c]),l.data[c]=d,l.addAutoUpdateObserver(d),l.disableFreeze||C(l.data[c]);else for(c;c<o;c++)l.data[c]=n.data[c],l.addAutoUpdateObserver(l.data[c]),l.disableFreeze||C(l.data[c]);if(l.maxId=typeof n.maxId=="undefined"?0:n.maxId,typeof n.binaryIndices!="undefined"&&(l.binaryIndices=n.binaryIndices),typeof n.transforms!="undefined"&&(l.transforms=n.transforms),l.uniqueNames=[],n.hasOwnProperty("uniqueNames")&&(l.uniqueNames=n.uniqueNames),typeof n.DynamicViews!="undefined"){for(let f=0;f<n.DynamicViews.length;f++){let m=n.DynamicViews[f],g=l.addDynamicView(m.name,m.options);g.resultdata=m.resultdata,g.resultsdirty=m.resultsdirty,g.filterPipeline=m.filterPipeline,g.sortCriteriaSimple=m.sortCriteriaSimple,g.sortCriteria=m.sortCriteria,g.sortFunction=null,g.sortDirty=m.sortDirty,l.disableFreeze||(C(g.filterPipeline),g.sortCriteriaSimple?C(g.sortCriteriaSimple):g.sortCriteria&&C(g.sortCriteria)),g.resultset.filteredrows=m.resultset.filteredrows,g.resultset.filterInitialized=m.resultset.filterInitialized,g.rematerialize({removeWhereFilters:!0})}e.databaseVersion<1.5&&(l.ensureAllIndexes(!0),l.dirty=!0)}}}close(e){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(e),e=void 0)),e&&this.on("close",e),this.emit("close")}closeAsync(){return D(this,null,function*(){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(yield this.saveDatabaseAsync())),this.emit("close")})}generateChangesNotification(e){function t({name:n}){return n}u(t,"getCollName");let i=[],r=e||this.collections.map(t);return this.collections.forEach(n=>{r.includes(t(n))&&(i=i.concat(n.getChanges()))}),i}serializeChanges(e){return JSON.stringify(this.generateChangesNotification(e))}deserializeChanges(e){return JSON.parse(e)}clearChanges(){this.collections.forEach(e=>{e.flushChanges&&e.flushChanges()})}throttledSaveDrain(e,t){let i=this,r=new Date().getTime();if(this.throttledSaves||e(!0),t=t||{},t.hasOwnProperty("recursiveWait")||(t.recursiveWait=!0),t.hasOwnProperty("recursiveWaitLimit")||(t.recursiveWaitLimit=!1),t.hasOwnProperty("recursiveWaitLimitDuration")||(t.recursiveWaitLimitDuration=2e3),t.hasOwnProperty("started")||(t.started=new Date().getTime()),this.throttledSaves&&this.throttledSavePending)if(t.recursiveWait)this.throttledCallbacks.push(()=>{if(i.throttledSavePending){if(t.recursiveWaitLimit&&r-t.started>t.recursiveWaitLimitDuration){e(!1);return}i.throttledSaveDrain(e,t);return}else{e(!0);return}});else{this.throttledCallbacks.push(e);return}else e(!0)}loadDatabase(e,t){let i=this;if(!this.throttledSaves){this.loadDatabaseInternal(e,t);return}this.throttledSaveDrain(r=>{if(r){i.throttledSavePending=!0,i.loadDatabaseInternal(e,n=>{i.throttledCallbacks.length===0?i.throttledSavePending=!1:i.saveDatabase(),typeof t=="function"&&t(n)});return}else typeof t=="function"&&t(new Error("Unable to pause save throttling long enough to read database"))},e)}loadDatabaseAsync(e){return D(this,null,function*(){return new Promise((t,i)=>{let r=u(o=>t(o),"resolveCallback"),n=u(o=>i(o),"rejectCallback"),l=this;if(!this.throttledSaves){this.loadDatabaseInternal(e,r);return}this.throttledSaveDrain(o=>{if(o){l.throttledSavePending=!0,l.loadDatabaseInternal(e,c=>{l.throttledCallbacks.length===0?l.throttledSavePending=!1:l.saveDatabase(),t(c)});return}else n(new Error("Unable to pause save throttling long enough to read database"))},e)})})}saveDatabaseInternal(e){let t=e||(r=>{if(r)throw r}),i=this;if(!this.persistenceAdapter){t(new Error("persistenceAdapter not configured"));return}if(this.persistenceAdapter.mode==="incremental"){let r;if(this.ignoreAutosave=!0,!("isAsync"in this.persistenceAdapter))this.persistenceAdapter.saveDatabase(this.filename,u(function(){if(i.ignoreAutosave=!1,r){t(new Error("adapter error - getLokiCopy called more than once"));return}let l=i.copy({removeNonSerializable:!0});return r=i.collections.map(({dirty:o,dirtyIds:c})=>[o,c]),i.collections.forEach(o=>{o.dirty=!1,o.dirtyIds=[]}),l},"getLokiCopy"),u(function(l){i.ignoreAutosave=!1,l&&r&&i.collections.forEach((o,c)=>{let h=r[c];o.dirty=o.dirty||h[0],o.dirtyIds=o.dirtyIds.concat(h[1])}),t(l)},"exportDatabaseCallback"));else{t(new Error("Async incremental persistenceAdapter handling not implemented in SylvieJS"));return}}else if(this.persistenceAdapter.mode==="reference")if(!("isAsync"in this.persistenceAdapter)&&this.persistenceAdapter.mode==="reference"&&typeof this.persistenceAdapter.exportDatabase=="function")this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),u(function(n){i.autosaveClearFlags(),t(n)},"exportDatabaseCallback"));else{t(new Error("Async reference persistenceAdapter handling not implemented in SylvieJS"));return}else{this.autosaveClearFlags();let r=u(n=>{t(n)},"afterSaveCallback");"isAsync"in this.persistenceAdapter?this.persistenceAdapter.saveDatabaseAsync(this.filename,this.serialize()).then(r).catch(r):this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),r)}}saveDatabase(e){if(!this.throttledSaves){this.saveDatabaseInternal(e);return}if(this.throttledSavePending){this.throttledCallbacks.push(e);return}let t=this.throttledCallbacks;this.throttledCallbacks=[],t.unshift(e),this.throttledSavePending=!0;let i=this;this.saveDatabaseInternal(r=>{i.throttledSavePending=!1,t.forEach(n=>{typeof n=="function"&&setTimeout(()=>{n(r)},1)}),i.throttledCallbacks.length>0&&i.saveDatabase()})}saveDatabaseAsync(){return D(this,null,function*(){return new Promise(e=>{let t=u(()=>e(),"resolveCallback");if(!this.throttledSaves){this.saveDatabaseInternal(t);return}if(this.throttledSavePending){this.throttledCallbacks.push(t);return}let i=this.throttledCallbacks;this.throttledCallbacks=[],i.unshift(t),this.throttledSavePending=!0;let r=this;this.saveDatabaseInternal(n=>{r.throttledSavePending=!1,i.forEach(l=>{typeof l=="function"&&setTimeout(()=>{l(n)},1)}),r.throttledCallbacks.length>0&&r.saveDatabase()})})})}deleteDatabase(e){let t=e||(i=>{if(i)throw i});if(this.persistenceAdapter!==null){let i=u(r=>{t(r)},"afterDeleteCallback");"isAsync"in this.persistenceAdapter?this.persistenceAdapter.deleteDatabaseAsync(this.filename).then(()=>{i({success:!0})}).catch(r=>{i(r)}):this.persistenceAdapter.deleteDatabase(this.filename,i)}else t(new Error("persistenceAdapter not configured"))}deleteDatabaseAsync(){return D(this,null,function*(){return new Promise((e,t)=>{let i=u(r=>{r instanceof Error?t(r):r!=null&&r.success?e(r):t(r)},"afterDeleteCallback");this.persistenceAdapter!==null?"isAsync"in this.persistenceAdapter?this.persistenceAdapter.deleteDatabaseAsync(this.filename).then(()=>{i({success:!0})}).catch(r=>{i(r)}):this.persistenceAdapter.deleteDatabase(this.filename,i):t(new Error("persistenceAdapter not configured"))})})}autosaveDirty(){for(let e=0;e<this.collections.length;e++)if(this.collections[e].dirty)return!0;return!1}autosaveClearFlags(){for(let e=0;e<this.collections.length;e++)this.collections[e].dirty=!1}autosaveEnable(e,t){this.autosave=!0;let i=5e3,r=this;typeof this.autosaveInterval!="undefined"&&this.autosaveInterval!==null&&(i=this.autosaveInterval),this.autosaveHandle=setInterval(u(function(){r.autosaveDirty()&&!r.ignoreAutosave&&r.saveDatabase(t)},"autosaveHandleInterval"),i)}autosaveDisable(){typeof this.autosaveHandle!="undefined"&&this.autosaveHandle!==null&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)}};u(w,"Sylvie");w.prototype.toJson=w.prototype.serialize;w.prototype.save=w.prototype.saveDatabase;w.deepFreeze=C;w.freeze=J;w.unFreeze=W;w.LokiOps=A;w.Collection=T;w.DynamicView=ce;w.Resultset=x;w.KeyValueStore=Ce;w.LokiMemoryAdapter=ee;w.LokiPartitioningAdapter=K;w.LokiLocalStorageAdapter=Q;w.LokiFsAdapter=H;w.persistenceAdapters={fs:H,localStorage:Q};w.aeq=ye;w.lt=be;w.gt=ve;w.Comparators=b;var te=w;typeof window!="undefined"&&Object.assign(window,{loki:te,Sylvie:te});var Xi=te;export{Xi as default};
//# sourceMappingURL=sylviejs.js.map
